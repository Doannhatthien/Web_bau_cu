<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng B·∫ßu C·ª≠ L·ªõp - Blockchain</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üó≥Ô∏è B·∫ßu C·ª≠ L·ªõp Blockchain</h1>
            <p class="subtitle">Minh b·∫°ch & B·∫£o m·∫≠t</p>
            
            <!-- Th√¥ng tin ng∆∞·ªùi d√πng -->
            <div class="user-info" id="userInfo">
                <div class="user-details">
                    <div class="user-avatar">üë§</div>
                    <div class="user-text">
                        <h3 id="userName">-</h3>
                        <p id="userRole">-</p>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">ƒêƒÉng xu·∫•t</button>
            </div>

            <!-- K·∫øt n·ªëi -->
            <div class="connection-status" id="connectionStatus">
                <div class="status-item">
                    <span>üîó</span>
                    <span id="statusText" class="status-disconnected">Ch∆∞a k·∫øt n·ªëi</span>
                </div>
                <div class="status-item">
                    <span>üí≥</span>
                    <span id="accountAddress">Ch∆∞a k·∫øt n·ªëi</span>
                </div>
            </div>

            <button id="connectWallet" class="btn btn-primary btn-large" onclick="connectWallet()" style="position: relative; z-index: 1000; cursor: pointer; pointer-events: auto;">
                ü¶ä K·∫øt n·ªëi MetaMask
            </button>
            

        </header>

        <!-- Ch·∫ø ƒë·ªô b·∫ßu c·ª≠ -->
        <div class="section" style="background: #f8f9fa; padding: 15px 20px; margin: 20px 0; border-radius: 12px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" style="flex: 1; min-width: 180px;">
                    üåê B·∫ßu c·ª≠ C√¥ng khai
                </button>
                <button onclick="window.location.href='private-voting.html'" class="btn btn-danger" style="flex: 1; min-width: 180px;">
                    üîí B·∫ßu c·ª≠ Kh√©p k√≠n
                </button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs" id="tabs">
            <button class="tab-button active" data-tab="voting">B·ªè Phi·∫øu</button>
            <button class="tab-button" data-tab="results">K·∫øt Qu·∫£</button>
            <button class="tab-button can-register" data-tab="registration" style="display: inline-block !important; visibility: visible !important;">ƒêƒÉng K√Ω ·ª®ng Vi√™n</button>
            <button class="tab-button admin-only" data-tab="admin" style="display: inline-block !important; visibility: visible !important;">Qu·∫£n Tr·ªã</button>
        </div>

        <!-- Voting Tab -->
        <div class="tab-content active" id="voting">
            <div class="section">
                <h2>üéØ Th√¥ng Tin B·∫ßu C·ª≠</h2>
                <div class="info-grid">
                    <div class="info-card">
                        <h3>Tr·∫°ng th√°i b·∫ßu c·ª≠</h3>
                        <p id="electionState" class="state-text">-</p>
                    </div>
                    <div class="info-card">
                        <h3>S·ªë ·ª©ng vi√™n</h3>
                        <p id="candidateCount" class="count-text">0</p>
                    </div>
                    <div class="info-card">
                        <h3>T·ªïng s·ªë phi·∫øu</h3>
                        <p id="totalVotes" class="count-text">0</p>
                    </div>
                    <div class="info-card">
                        <h3>Tr·∫°ng th√°i c·ªßa b·∫°n</h3>
                        <p id="voterStatus" class="status-text">-</p>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>üë• Danh S√°ch ·ª®ng Vi√™n</h2>
                <div id="candidatesList" class="candidates-list">
                    <p class="empty-state">Ch∆∞a c√≥ ·ª©ng vi√™n n√†o</p>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div class="tab-content" id="results">
            <div class="section">
                <h2>üìä K·∫øt Qu·∫£ B·∫ßu C·ª≠</h2>
                <button id="refreshResults" class="btn btn-secondary">L√†m m·ªõi k·∫øt qu·∫£</button>
                <div id="resultsList" class="results-list">
                    <p class="empty-state">Ch∆∞a c√≥ k·∫øt qu·∫£</p>
                </div>
            </div>
        </div>

        <!-- Registration Tab -->
        <div class="tab-content can-register" id="registration">
            <div class="section">
                <h2>üìù ƒêƒÉng K√Ω ·ª®ng Vi√™n</h2>
                
                <form id="candidateForm" class="form">
                    <div class="form-group">
                        <label for="candidateName">H·ªç v√† t√™n:</label>
                        <input type="text" id="candidateName" placeholder="Nguy·ªÖn VƒÉn A" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="candidatePosition">V·ªã tr√≠ ·ª©ng c·ª≠:</label>
                        <select id="candidatePosition" required>
                            <option value="">-- Ch·ªçn v·ªã tr√≠ --</option>
                            <option value="Lop truong">L·ªõp tr∆∞·ªüng</option>
                            <option value="Lop pho">L·ªõp ph√≥</option>
                            <option value="Bi thu">B√≠ th∆∞</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success" id="registerCandidateBtn">ƒêƒÉng k√Ω ·ª©ng c·ª≠</button>
                </form>
            </div>
        </div>

        <!-- Admin Tab -->
        <div class="tab-content admin-only" id="admin">
            <div class="section">
                <h2>‚öôÔ∏è Qu·∫£n Tr·ªã H·ªá Th·ªëng</h2>
                <p>Ch·ª©c nƒÉng qu·∫£n tr·ªã d√†nh cho admin</p>
                
                <!-- Qu·∫£n l√Ω tr·∫°ng th√°i b·∫ßu c·ª≠ -->
                <div class="admin-section">
                    <h3>üìä ƒêi·ªÅu Khi·ªÉn Tr·∫°ng Th√°i B·∫ßu C·ª≠</h3>
                    <div class="admin-buttons">
                        <button onclick="startRegistration()" class="btn btn-primary">
                            ‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω ·ª©ng vi√™n
                        </button>
                        <button onclick="startVoting()" class="btn btn-success">
                            üó≥Ô∏è B·∫Øt ƒë·∫ßu b·ªè phi·∫øu
                        </button>
                        <button onclick="endElection()" class="btn btn-danger">
                            üèÅ K·∫øt th√∫c b·∫ßu c·ª≠
                        </button>
                    </div>
                </div>
                
                <!-- ƒêƒÉng k√Ω c·ª≠ tri -->
                <div class="admin-section">
                    <h3>üë• ƒêƒÉng K√Ω C·ª≠ Tri</h3>
                    <div class="form-group">
                        <label>ƒê·ªãa ch·ªâ v√≠ c·ª≠ tri:</label>
                        <input type="text" id="voterAddress" placeholder="0x..." class="form-control">
                        <button onclick="registerVoter()" class="btn btn-primary" style="margin-top: 10px;">
                            ƒêƒÉng k√Ω c·ª≠ tri
                        </button>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>ƒêƒÉng k√Ω nhi·ªÅu c·ª≠ tri (m·ªói ƒë·ªãa ch·ªâ 1 d√≤ng):</label>
                        <textarea id="voterAddresses" rows="5" placeholder="0x...&#10;0x...&#10;0x..." class="form-control"></textarea>
                        <button onclick="registerMultipleVoters()" class="btn btn-primary" style="margin-top: 10px;">
                            ƒêƒÉng k√Ω h√†ng lo·∫°t
                        </button>
                    </div>
                </div>
                
                <!-- Th√™m ·ª©ng vi√™n -->
                <div class="admin-section">
                    <h3>‚ûï Th√™m ·ª®ng Vi√™n (Admin)</h3>
                    <div class="form-group">
                        <label>T√™n ·ª©ng vi√™n:</label>
                        <input type="text" id="adminCandidateName" placeholder="Nguy·ªÖn VƒÉn A" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>V·ªã tr√≠:</label>
                        <select id="adminCandidatePosition" class="form-control">
                            <option value="Lop truong">L·ªõp tr∆∞·ªüng</option>
                            <option value="Lop pho">L·ªõp ph√≥</option>
                            <option value="Bi thu">B√≠ th∆∞</option>
                        </select>
                    </div>
                    <button onclick="addCandidateAdmin()" class="btn btn-success">
                        Th√™m ·ª©ng vi√™n
                    </button>
                </div>
                
                <!-- Danh s√°ch sinh vi√™n t·ª´ MongoDB -->
                <div class="admin-section">
                    <h3>üë®‚Äçüéì Danh S√°ch Sinh Vi√™n (MongoDB)</h3>
                    <button onclick="loadUsersFromMongoDB()" class="btn btn-primary" style="margin-bottom: 15px;">
                        üîÑ T·∫£i danh s√°ch
                    </button>
                    <div id="usersList" style="max-height: 400px; overflow-y: auto;">
                        <p class="empty-state">Click "T·∫£i danh s√°ch" ƒë·ªÉ xem</p>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>¬© 2025 - H·ªá Th·ªëng B·∫ßu C·ª≠ L·ªõp Blockchain | Ph√°t tri·ªÉn v·ªõi Ethereum & Solidity</p>
        </footer>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>ƒêang x·ª≠ l√Ω...</p>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script>
        // KH√îNG D√ôNG app.js N·ªÆA - NH√öNG CODE TR·ª∞C TI·∫æP
        let web3, contract, userAccount, isAdmin = false;
        
        const CONTRACT_ADDRESS = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
        const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"candidateId","type":"uint256"},{"indexed":false,"internalType":"string","name":"name","type":"string"},{"indexed":false,"internalType":"string","name":"position","type":"string"}],"name":"CandidateRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"enum ClassElection.ElectionState","name":"newState","type":"uint8"}],"name":"ElectionStateChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"voter","type":"address"},{"indexed":false,"internalType":"uint256","name":"candidateId","type":"uint256"}],"name":"Voted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"voter","type":"address"}],"name":"VoterRegistered","type":"event"},{"inputs":[{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_position","type":"string"}],"name":"addCandidate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_position","type":"string"}],"name":"addPosition","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"candidates","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"position","type":"string"},{"internalType":"uint256","name":"voteCount","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"candidatesCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"endElection","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getCandidates","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"position","type":"string"},{"internalType":"uint256","name":"voteCount","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"internalType":"struct ClassElection.Candidate[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"getPosition","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getPositionsCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getResults","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"position","type":"string"},{"internalType":"uint256","name":"voteCount","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"internalType":"struct ClassElection.Candidate[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalVotes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"positions","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_position","type":"string"}],"name":"registerCandidate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_voter","type":"address"}],"name":"registerVoter","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"_voters","type":"address[]"}],"name":"registerVoters","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"resetElection","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"startRegistration","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"startVoting","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"state","outputs":[{"internalType":"enum ClassElection.ElectionState","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_candidateId","type":"uint256"}],"name":"vote","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"voterAddresses","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"voters","outputs":[{"internalType":"bool","name":"isRegistered","type":"bool"},{"internalType":"bool","name":"hasVoted","type":"bool"},{"internalType":"uint256","name":"votedCandidateId","type":"uint256"},{"internalType":"bool","name":"canRegisterCandidates","type":"bool"}],"stateMutability":"view","type":"function"}];
        
        // Connect MetaMask
        async function connectWallet() {
            console.log('connectWallet function called');
            console.log('window.ethereum:', window.ethereum);
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('‚ùå Vui l√≤ng c√†i ƒë·∫∑t MetaMask!\n\nDownload t·∫°i: https://metamask.io');
                    window.open('https://metamask.io/download/', '_blank');
                    return;
                }
                
                // Th√™m/chuy·ªÉn sang m·∫°ng Hardhat Local
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x7A69' }], // 31337 in hex
                    });
                } catch (switchError) {
                    // N·∫øu m·∫°ng ch∆∞a ƒë∆∞·ª£c th√™m, th√™m m·ªõi
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x7A69',
                                    chainName: 'Hardhat Local',
                                    nativeCurrency: {
                                        name: 'Ether',
                                        symbol: 'ETH',
                                        decimals: 18
                                    },
                                    rpcUrls: ['http://127.0.0.1:8545'],
                                    blockExplorerUrls: null
                                }]
                            });
                        } catch (addError) {
                            alert('‚ùå Kh√¥ng th·ªÉ th√™m m·∫°ng Hardhat Local!\n\nVui l√≤ng th√™m th·ªß c√¥ng:\nRPC URL: http://127.0.0.1:8545\nChain ID: 31337');
                            return;
                        }
                    } else {
                        alert('‚ùå Kh√¥ng th·ªÉ chuy·ªÉn sang m·∫°ng Hardhat Local!\n\n' + switchError.message);
                        return;
                    }
                }
                
                console.log('Requesting accounts...');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                console.log('Connected account:', userAccount);
                
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                console.log('Contract initialized:', CONTRACT_ADDRESS);
                
                // Check if admin (with error handling)
                try {
                    const adminAddress = await contract.methods.admin().call();
                    isAdmin = (userAccount.toLowerCase() === adminAddress.toLowerCase());
                    console.log('Is admin:', isAdmin);
                } catch (err) {
                    console.warn('Could not check admin status:', err);
                    isAdmin = false;
                }
                
                // Ki·ªÉm tra quy·ªÅn ƒëƒÉng k√Ω ·ª©ng vi√™n
                let canRegisterCandidates = isAdmin;
                try {
                    const voterInfo = await contract.methods.voters(userAccount).call();
                    canRegisterCandidates = isAdmin || voterInfo.canRegisterCandidates;
                } catch (error) {
                    console.log('Cannot check canRegisterCandidates, using admin status only');
                }
                
                // T·∫•t c·∫£ tabs ƒë·ªÅu hi·ªÉn th·ªã lu√¥n - kh√¥ng c·∫ßn ki·ªÉm tra quy·ªÅn ·ªü ƒë√¢y
                console.log('User permissions - Admin:', isAdmin, 'Can register:', canRegisterCandidates);
                
                // Kh√¥ng c·∫ßn ki·ªÉm tra quy·ªÅn n·ªØa - t·∫•t c·∫£ tabs ƒë·ªÅu hi·ªÉn th·ªã
                // Ch·ªâ c·∫ßn ki·ªÉm tra khi ng∆∞·ªùi d√πng th·ª±c hi·ªán h√†nh ƒë·ªông c·ª• th·ªÉ
                
                // Update UI
                document.getElementById('statusText').textContent = 'ƒê√£ k·∫øt n·ªëi';
                document.getElementById('statusText').className = 'status-connected';
                document.getElementById('accountAddress').textContent = userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                document.getElementById('connectWallet').style.display = 'none';
                
                // ·∫®n th√¥ng b√°o h∆∞·ªõng d·∫´n
                const walletNotice = document.getElementById('walletNotice');
                if (walletNotice) {
                    walletNotice.style.display = 'none';
                }
                
                let adminMessage = '';
                if (isAdmin) {
                    adminMessage = '\n\nüîë B·∫°n l√† Admin - C√≥ quy·ªÅn truy c·∫≠p ƒë·∫ßy ƒë·ªß c√°c ch·ª©c nƒÉng qu·∫£n tr·ªã!';
                } else if (canRegisterCandidates) {
                    adminMessage = '\n\n‚úÖ B·∫°n c√≥ quy·ªÅn ƒëƒÉng k√Ω l√†m ·ª©ng vi√™n!';
                }
                
                alert('‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!' + adminMessage);
                
                // Load d·ªØ li·ªáu ngay sau khi k·∫øt n·ªëi
                await loadElectionData();
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå L·ªói: ' + error.message);
            }
        }
        
        // Load d·ªØ li·ªáu b·∫ßu c·ª≠
        async function loadElectionData() {
            if (!contract || !userAccount) {
                console.warn('Contract or account not initialized');
                return;
            }
            try {
                const state = await contract.methods.state().call();
                const stateNames = ['Thi·∫øt l·∫≠p', 'ƒêƒÉng k√Ω ·ª©ng vi√™n', 'ƒêang b·ªè phi·∫øu', 'ƒê√£ k·∫øt th√∫c'];
                const electionStateEl = document.getElementById('electionState');
                if (electionStateEl) electionStateEl.textContent = stateNames[state];
                
                const candidates = await contract.methods.getCandidates().call();
                const candidateCountEl = document.getElementById('candidateCount');
                if (candidateCountEl) candidateCountEl.textContent = candidates.length;
                
                const totalVotes = await contract.methods.getTotalVotes().call();
                const totalVotesEl = document.getElementById('totalVotes');
                if (totalVotesEl) totalVotesEl.textContent = totalVotes;
                
                const voterInfo = await contract.methods.voters(userAccount).call();
                const voterStatusEl = document.getElementById('voterStatus');
                if (voterStatusEl) {
                    if (!voterInfo.isRegistered) {
                        voterStatusEl.textContent = 'Ch∆∞a ƒëƒÉng k√Ω';
                    } else if (voterInfo.hasVoted) {
                        voterStatusEl.textContent = 'ƒê√£ b·ªè phi·∫øu';
                    } else {
                        voterStatusEl.textContent = 'C√≥ th·ªÉ b·ªè phi·∫øu';
                    }
                }
                
                await loadCandidates();
            } catch (error) {
                console.error('Error loading data:', error);
                // Don't show alert to user, just log it
            }
        }
        
        // Load danh s√°ch ·ª©ng vi√™n
        async function loadCandidates() {
            if (!contract || !userAccount) {
                console.warn('Contract or account not initialized');
                return;
            }
            try {
                const candidates = await contract.methods.getCandidates().call();
                const candidatesListDiv = document.getElementById('candidatesList');
                if (!candidatesListDiv) {
                    console.warn('Candidates list div not found');
                    return;
                }
                
                if (candidates.length === 0) {
                    candidatesListDiv.innerHTML = '<p class="empty-state">Ch∆∞a c√≥ ·ª©ng vi√™n n√†o</p>';
                    return;
                }
                
                const voterInfo = await contract.methods.voters(userAccount).call();
                const canVote = voterInfo.isRegistered && !voterInfo.hasVoted;
                
                candidatesListDiv.innerHTML = candidates.map(candidate => `
                    <div class="candidate-card">
                        <h3>${candidate.name}</h3>
                        <p class="candidate-position">${candidate.position}</p>
                        <p class="candidate-votes">${candidate.voteCount} phi·∫øu</p>
                        ${canVote ? `<button onclick="voteForCandidate(${candidate.id})" class="btn btn-primary">B·∫ßu cho ·ª©ng vi√™n n√†y</button>` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading candidates:', error);
            }
        }
        
        // B·ªè phi·∫øu
        async function voteForCandidate(candidateId) {
            if (!contract || !userAccount) {
                alert('Vui l√≤ng k·∫øt n·ªëi MetaMask!');
                return;
            }
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën b·ªè phi·∫øu cho ·ª©ng vi√™n n√†y?')) return;
            try {
                await contract.methods.vote(candidateId).send({ from: userAccount });
                alert('‚úÖ B·ªè phi·∫øu th√†nh c√¥ng!');
                await loadElectionData();
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }
        
        // Load k·∫øt qu·∫£
        async function loadResults() {
            if (!contract) return;
            try {
                const results = await contract.methods.getResults().call();
                const resultsDiv = document.getElementById('resultsList');
                if (!resultsDiv) return;
                
                if (results.length === 0) {
                    resultsDiv.innerHTML = '<p class="empty-state">Ch∆∞a c√≥ k·∫øt qu·∫£</p>';
                    return;
                }
                
                const sortedResults = [...results].sort((a, b) => Number(b.voteCount) - Number(a.voteCount));
                resultsDiv.innerHTML = sortedResults.map((candidate, index) => `
                    <div class="result-card ${index === 0 ? 'winner' : ''}">
                        <div class="result-rank">#${index + 1}</div>
                        <div class="result-info">
                            <h3>${candidate.name}</h3>
                            <p>${candidate.position}</p>
                        </div>
                        <div class="result-votes">
                            <span class="vote-count">${candidate.voteCount}</span>
                            <span class="vote-label">phi·∫øu</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }
        
        // ƒêƒÉng k√Ω ·ª©ng c·ª≠
        async function registerAsCandidate(e) {
            e.preventDefault();
            if (!contract || !userAccount) {
                alert('Vui l√≤ng k·∫øt n·ªëi MetaMask!');
                return;
            }
            
            const name = document.getElementById('candidateName').value.trim();
            const position = document.getElementById('candidatePosition').value;
            
            if (!name || !position) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }
            
            try {
                console.log('Calling registerCandidate:', name, position);
                console.log('From account:', userAccount);
                const state = await contract.methods.state().call();
                const voter = await contract.methods.voters(userAccount).call();
                console.log('Current state:', state, 'Voter registered:', voter.isRegistered);
                
                await contract.methods.registerCandidate(name, position).send({ from: userAccount });
                alert('‚úÖ ƒêƒÉng k√Ω ·ª©ng c·ª≠ th√†nh c√¥ng!');
                document.getElementById('candidateForm').reset();
                await loadElectionData();
                switchTab('voting');
            } catch (error) {
                console.error('L·ªói:', error);
                alert('L·ªói: ' + error.message);
            }
        }
        
        // Admin functions
        async function startRegistration() {
            if (!contract) return;
            try {
                console.log('Calling startRegistration from account:', userAccount);
                const state = await contract.methods.state().call();
                console.log('Current state before startRegistration:', state);
                
                await contract.methods.startRegistration().send({ from: userAccount });
                alert('‚úÖ ƒê√£ b·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω!');
                await loadElectionData();
            } catch (error) {
                console.error('Error in startRegistration:', error);
                alert('L·ªói: ' + error.message);
            }
        }
        
        async function startVoting() {
            if (!contract) return;
            try {
                await contract.methods.startVoting().send({ from: userAccount });
                alert('‚úÖ ƒê√£ b·∫Øt ƒë·∫ßu b·ªè phi·∫øu!');
                await loadElectionData();
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }
        
        async function endElection() {
            if (!contract) return;
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën k·∫øt th√∫c b·∫ßu c·ª≠?')) return;
            try {
                await contract.methods.endElection().send({ from: userAccount });
                alert('‚úÖ ƒê√£ k·∫øt th√∫c b·∫ßu c·ª≠!');
                await loadElectionData();
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }
        
        async function registerVoter() {
            const address = document.getElementById('voterAddress').value.trim();
            if (!address) {
                alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ!');
                return;
            }
            try {
                console.log('Calling registerVoter for address:', address);
                console.log('From account:', userAccount);
                const state = await contract.methods.state().call();
                console.log('Current state:', state);
                
                await contract.methods.registerVoter(address).send({ from: userAccount });
                alert('‚úÖ ƒêƒÉng k√Ω c·ª≠ tri th√†nh c√¥ng!');
                document.getElementById('voterAddress').value = '';
                await loadElectionData();
            } catch (error) {
                console.error('Error in registerVoter:', error);
                alert('L·ªói: ' + error.message);
            }
        }
        
        async function registerMultipleVoters() {
            const addresses = document.getElementById('voterAddresses').value.trim().split('\n').filter(a => a.trim());
            if (addresses.length === 0) {
                alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ!');
                return;
            }
            try {
                await contract.methods.registerVoters(addresses).send({ from: userAccount });
                alert(`‚úÖ ƒê√£ ƒëƒÉng k√Ω ${addresses.length} c·ª≠ tri! (C√≥ quy·ªÅn ƒëƒÉng k√Ω ·ª©ng vi√™n)`);
                document.getElementById('voterAddresses').value = '';
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }
        
        async function addCandidateAdmin() {
            const name = document.getElementById('adminCandidateName').value.trim();
            const position = document.getElementById('adminCandidatePosition').value;
            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n!');
                return;
            }
            try {
                await contract.methods.addCandidate(name, position).send({ from: userAccount });
                alert('‚úÖ ƒê√£ th√™m ·ª©ng vi√™n!');
                document.getElementById('adminCandidateName').value = '';
                await loadElectionData();
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }
        
        // Load danh s√°ch users t·ª´ MongoDB
        async function loadUsersFromMongoDB() {
            try {
                const response = await fetch('http://localhost:5000/api/auth/users', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch users');
                }
                
                const result = await response.json();
                const users = result.data;
                
                const usersListDiv = document.getElementById('usersList');
                
                if (!users || users.length === 0) {
                    usersListDiv.innerHTML = '<p class="empty-state">Ch∆∞a c√≥ sinh vi√™n n√†o</p>';
                    return;
                }
                
                usersListDiv.innerHTML = users.map(user => `
                    <div class="candidate-card" style="margin-bottom: 15px;">
                        <h4>${user.username} ${user.role === 'admin' ? 'üëë' : ''}</h4>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Wallet:</strong> ${user.walletAddress}</p>
                        <p><strong>Vai tr√≤:</strong> ${user.role === 'admin' ? 'Admin' : 'Sinh vi√™n'}</p>
                        <button onclick="registerVoterFromUser('${user.walletAddress}')" class="btn btn-primary btn-small">
                            ‚úÖ ƒêƒÉng k√Ω v√†o Blockchain
                        </button>
                    </div>
                `).join('');
                
                alert(`‚úÖ ƒê√£ t·∫£i ${users.length} sinh vi√™n t·ª´ MongoDB!`);
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå L·ªói: ' + error.message + '\n\nƒê·∫£m b·∫£o backend ƒëang ch·∫°y t·∫°i http://localhost:5000');
            }
        }
        
        // ƒêƒÉng k√Ω c·ª≠ tri t·ª´ user MongoDB
        async function registerVoterFromUser(walletAddress) {
            if (!contract || !userAccount) {
                alert('Vui l√≤ng k·∫øt n·ªëi MetaMask!');
                return;
            }
            
            if (!confirm(`ƒêƒÉng k√Ω ƒë·ªãa ch·ªâ ${walletAddress} v√†o blockchain?`)) {
                return;
            }
            
            try {
                await contract.methods.registerVoter(walletAddress).send({ from: userAccount });
                alert('‚úÖ ƒê√£ ƒëƒÉng k√Ω c·ª≠ tri v√†o blockchain!');
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }
        
        // Tab switching
        function switchTab(tabName) {
            console.log('=== switchTab called with:', tabName);
            
            const targetTab = document.getElementById(tabName);
            const targetButton = document.querySelector(`[data-tab="${tabName}"]`);
            
            console.log('Target tab element:', targetTab);
            console.log('Target button element:', targetButton);
            
            if (!targetTab || !targetButton) {
                console.error('Tab or button not found:', tabName);
                return;
            }
            
            // Ki·ªÉm tra xem button c√≥ ƒëang b·ªã ·∫©n kh√¥ng (kh√¥ng c√≥ quy·ªÅn)
            const buttonStyle = window.getComputedStyle(targetButton);
            console.log('Button display style:', buttonStyle.display);
            
            if (buttonStyle.display === 'none') {
                alert('‚õî B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p tab n√†y!');
                return;
            }
            
            // ·∫®N T·∫§T C·∫¢ c√°c tab content - FORCE REMOVE ACTIVE
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none'; // Force ·∫©n
                console.log('Hidden tab:', tab.id);
            });
            
            // Remove active t·ª´ t·∫•t c·∫£ buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // CH·ªà HI·ªÇN TH·ªä tab ƒë∆∞·ª£c ch·ªçn
            targetTab.classList.add('active');
            targetTab.style.display = 'block'; // Force hi·ªÉn th·ªã
            targetButton.classList.add('active');
            
            console.log('Switched to tab:', tabName, 'Tab classes:', targetTab.className);
            
            if (tabName === 'results') {
                loadResults();
            } else if (tabName === 'voting') {
                loadElectionData();
            }
        }
        
        // ·∫®N LOADING OVERLAY NGAY KHI LOAD TRANG
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            
            // ƒê·∫£m b·∫£o t·∫•t c·∫£ n√∫t c√≥ th·ªÉ click
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(btn => {
                btn.style.pointerEvents = 'auto';
                btn.style.cursor = 'pointer';
                btn.style.position = 'relative';
                btn.style.zIndex = '10';
            });
            
            // Attach event listeners cho tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    console.log('Tab button clicked:', button.dataset.tab);
                    switchTab(button.dataset.tab);
                });
            });
            
            // Form submit
            const candidateForm = document.getElementById('candidateForm');
            if (candidateForm) {
                candidateForm.addEventListener('submit', registerAsCandidate);
            }
            
            // FORCE HI·ªÇN TH·ªä T·∫§T C·∫¢ TABS - ƒê·∫£m b·∫£o kh√¥ng b·ªã CSS hay JS n√†o ·∫©n
            setTimeout(() => {
                console.log('FORCING ALL TABS TO SHOW...');
                document.querySelectorAll('.tab-button.admin-only, .tab-button.can-register').forEach(btn => {
                    btn.style.display = 'inline-block';
                    btn.style.visibility = 'visible';
                    btn.style.opacity = '1';
                    console.log('Forced show:', btn.textContent);
                });
                console.log('All tabs forced to show!');
            }, 100);
            
            // Connect wallet button - ƒë√£ d√πng onclick trong HTML, kh√¥ng c·∫ßn addEventListener
            console.log('Page loaded and ready');
        });
    </script>
    <script>
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        function checkAuth() {
            const currentUser = sessionStorage.getItem('current_user') || localStorage.getItem('current_user');
            if (!currentUser) {
                // Ch·ªâ redirect n·∫øu kh√¥ng ph·∫£i ƒëang ·ªü trang hi·ªán t·∫°i
                if (!window.location.href.includes('login.html')) {
                    setTimeout(() => {
                        const stillNoUser = sessionStorage.getItem('current_user') || localStorage.getItem('current_user');
                        if (!stillNoUser) {
                            window.location.href = 'login.html';
                        }
                    }, 1000);
                }
                return null;
            } else {
                const user = JSON.parse(currentUser);
                console.log('Logged in as:', user.username);
                
                // Hi·ªÉn th·ªã th√¥ng tin user - CH·ªà KHI ELEMENT T·ªíN T·∫†I
                const userNameEl = document.getElementById('userName');
                const userRoleEl = document.getElementById('userRole');
                
                if (userNameEl) {
                    userNameEl.textContent = user.fullName;
                }
                if (userRoleEl) {
                    userRoleEl.textContent = user.role === 'admin' ? 'Qu·∫£n tr·ªã vi√™n' : 'Sinh vi√™n - ' + user.studentId;
                }
                
                return user;
            }
        }
        
        // Logout & Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const user = checkAuth();
            
            // Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                        sessionStorage.removeItem('current_user');
                        localStorage.removeItem('current_user');
                        window.location.href = 'login.html';
                    }
                });
            }
            
            // Refresh results button
            const refreshBtn = document.getElementById('refreshResults');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', loadResults);
            }
        });
    </script>
</body>
</html>
